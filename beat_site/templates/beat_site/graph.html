{% extends "beat_site/base.html" %}
  {% block content %}
  {% load static %}
  <div class ="MainContainer">
    <div class="WhiteParallaxContainer">
          <div class="row">
              <div class="col-4">
                <div class="center card border-3">
                    <h1 class="text-white">A 3D Representation</h2>
                    <div class="card-body">
                        <p>Year: {{ year }}</p>
                        <p>X-axis: {% if condition == 'gdp' %} GDP (log-scaled){% elif condition == 'co2' %} CO2 Emissions (metric tons per capita) {% endif %} 
                        </p>
                        <p>Y-axis: Infant Mortality Rate
                        </p>
                        <p>Z-axis: Frequency
                        </p>
                        {% if year != 'all' %}
                            <a class="btn btn-light" href="{% url 'graph' condition prev_year%}"> Previous Year</a>
                            <a class="btn btn-light" href="{% url 'graph' condition next_year%}"> Next Year</a><br><br>
                            <a class="btn btn-light" href="{% url 'graph' condition 1960%}"> 1960</a>
                            <a class="btn btn-light" href="{% url 'graph' condition 1970%}"> 1970</a>
                            <a class="btn btn-light" href="{% url 'graph' condition 1980%}"> 1980</a>
                            <a class="btn btn-light" href="{% url 'graph' condition 1990%}"> 1990</a>
                            <a class="btn btn-light" href="{% url 'graph' condition 2000%}"> 2000</a>
                            <a class="btn btn-light" href="{% url 'graph' condition 2010%}"> 2010</a>
                        {% endif %}
                    </div>
                </div>
              </div>
              <div class="col-8">
                <div class="shadow bg-white rounded"id="3dGraph"></div>
              </div>
          </div>
        </div>
        <div class="LightContentContainer">
          <h1 class="dist-page-title text-white">Pick a GDP Range to Condition On</h1>
            <div class="container">
               <div class="row justify-content-lg-center">
                <div class="col-4">
                    <div class="card text-center shadow-lg p-3 mb-5 bg-black rounded">
                      <div class="card-header">Indicate a Range (in billions $USD)</div><br>
                      <div class="container">
                        <div class="row">
                          <div class="col-sm">
                            <form method="GET">
                                <div class="input-group-prepend">
                                  <span class="input-group-text">Min</span>
                                </div>
                                <input type="text" class="form-control" aria-label="Min" aria-describedby="inputGroup-sizing-default" id="range_min">
                              </div>
                              <div class="col-sm">
                                <div class="input-group-prepend">
                                  <span class="input-group-text">Max</span>
                                </div>
                                <input type="text" class="form-control" aria-label="Max" aria-describedby="inputGroup-sizing-default" id="range_max">
                              </div>
                            </form>
                        </div>
                      </div><br>
                      <input type="button" value="See Results" id = "showResultsBtn" class="btn btn-secondary btn-large" method="GET">
                    </div>
                   </div>
                <div class="col-8">
                  <div class="container">
                      <canvas id="distChart"></canvas>
                  </div>
                </div>
               </div>
              </div>
            </div>
        </div>
  <script type="text/javascript">
      //3D plot
    var z_data = {{ z_array }};
    var data = [{
    z: z_data,
    type: 'surface'
          }];
    var gdp_xaxis = {title: '{{ condition }}',
                   ticktext:['< 1','1-2','2-3','3-4','4-5','5-6','6-7','7-8','8-9','9-10','> 10',],
                   tickvals:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]}
    var layout = {
    scene: {
        camera: {eye: {x: 1.5, y:1.5, z: 1.5}},
        xaxis: gdp_xaxis,
        yaxis:{title: 'Infant Mortality Rate',
               ticktext:['< 10','10-20','20-30','30-40','40-50','50-60','60-70','70-80','80-90','90-100','> 100',],
               tickvals:[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]},
        zaxis:{title: 'Frequency'},
    },
    autosize: true,
    width: 800,
    height: 600,
    margin: {
      l: 15,
      r: 15,
      b: 15,
      t: 0,
    },
    };
    Plotly.newPlot('3dGraph', data, layout, {showSendToCloud: true});

    var showResultsBtn = document.getElementById("showResultsBtn")
    var labels = ["0-10", "10-20", "20-30", "30-40", "40-50", "50-10", "60-10", "60-70", "70-80", "80-90", "90-100", "100-110", "110-120", "120-130", "130-140", "140-150", "150-160", "160-170", "170-180", "180-190", "190-200", ">200"]

    //Dear future Leon, fix for empty min or max 


    showResultsBtn.addEventListener('click', function() {
        min = $("#range_min").val();
        max = $("#range_max").val();
        year = '{{ year }}';
        console.log(min)
        $.ajax({
            url: "{% url 'update-dist' %}",
            method: 'GET',
            data : {
                'min': min,
                'max': max,
                'year': year
            },
            success: function(data){
                if (year != 'all'){
                    distChart.data.datasets[0].label = String('Frequency of IMR for All Countries in {{ year }} Given GDP Range $').concat(min, ' - $', max, ' Billion');
                } else {
                    distChart.data.datasets[0].label = String('Frequency of IMR for All Datapoints Given GDP Range $').concat(min, ' - $', max, ' Billion');
                }
                distChart.data.labels = labels;
                distChart.data.datasets[0].data = data.data;
                distChart.update()
            },
            error: function(error_data){
                console.log("error")
                console.log(error_data)
            }
        });
    }, false);


    var distChart = new Chart(document.getElementById("distChart"), {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: 'rgba(247, 108, 108, 0.5)',
                pointRadius: 0,
                fill: false,
                borderWidth: 5,
                borderColor: 'rgba(247, 108, 108, 0.5)',
                steppedLine: false,
            }]
          }
      })

  </script>
  {% endblock content %}